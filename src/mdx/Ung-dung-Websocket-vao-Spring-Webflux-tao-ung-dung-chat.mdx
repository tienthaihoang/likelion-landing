---
title: ·ª®ng d·ª•ng Websocket v√†o trong Spring Webflux ƒë·ªÉ t·∫°o c√°c ·ª©ng d·ª•ng chat c√≥ t√≠nh t∆∞∆°ng t√°c cao
slug: Ung-dung-Websocket-vao-Spring-Webflux-tao-ung-dung-chat
excerpt: S·ª≠ d·ª•ng WebSockets trong ng·ªØ c·∫£nh c·ªßa Spring WebFlux. Tri·ªÉn khai k·∫øt n·ªëi WebSocket, x·ª≠ l√Ω tin nh·∫Øn v√† qu·∫£n l√Ω tr·∫°ng th√°i k·∫øt n·ªëi.
thumbnail: https://res.cloudinary.com/dbscqlwl7/image/upload/v1695350151/blogs/Ung-dung-Websocket-vao-Spring-Webflux-tao-ung-dung-chat/BLog_Thumbnail_kmczxk.png
thumbnail_desktop: https://res.cloudinary.com/dbscqlwl7/image/upload/v1695350150/blogs/Ung-dung-Websocket-vao-Spring-Webflux-tao-ung-dung-chat/BLog_Desktop_j7dosv.png
thumbnail_mobile: https://res.cloudinary.com/dbscqlwl7/image/upload/v1695350151/blogs/Ung-dung-Websocket-vao-Spring-Webflux-tao-ung-dung-chat/BLog_Mobile_undw3z.png
thumbnail_og: https://res.cloudinary.com/dbscqlwl7/image/upload/v1695350151/blogs/Ung-dung-Websocket-vao-Spring-Webflux-tao-ung-dung-chat/BLog_Thumbnail_Social_dwrfdp.png
tags: tutorial
publishOn: 1695350214
---

Trong th·∫ø gi·ªõi ph√°t tri·ªÉn ·ª©ng d·ª•ng hi·ªán ƒë·∫°i, s·ª± t∆∞∆°ng t√°c th·ªùi gian th·ª±c v√† ƒë·ªông ƒë√£ tr·ªü th√†nh m·ªôt y·∫øu t·ªë quan tr·ªçng ƒë·ªëi v·ªõi tr·∫£i nghi·ªám ng∆∞·ªùi d√πng. ƒê·ªÉ ƒë√°p ·ª©ng v·ªõi nhu c·∫ßu n√†y, c√°c k·ªπ thu·∫≠t giao ti·∫øp nh∆∞ Long Polling v√† Server-Sent Events (SSE) ƒë√£ xu·∫•t hi·ªán ƒë·ªÉ cho ph√©p ·ª©ng d·ª•ng g·ª≠i d·ªØ li·ªáu t·ª´ m√°y ch·ªß ƒë·∫øn m√°y kh√°ch m√† kh√¥ng c·∫ßn s·ª± can thi·ªáp c·ªßa m√°y kh√°ch.

Tuy nhi√™n, m·ªôt c√¥ng ngh·ªá kh√°c ƒë√£ nhanh ch√≥ng tr·ªü n√™n ph·ªï bi·∫øn trong vi·ªác x√¢y d·ª±ng c√°c ·ª©ng d·ª•ng th·ªùi gian th·ª±c: WebSocket. WebSocket cung c·∫•p m·ªôt c√°ch ƒë·ªÉ thi·∫øt l·∫≠p m·ªôt k·∫øt n·ªëi li√™n t·ª•c gi·ªØa m√°y kh√°ch v√† m√°y ch·ªß, cho ph√©p d·ªØ li·ªáu ƒë∆∞·ª£c truy·ªÅn ƒëi v√† ƒë·∫øn hai chi·ªÅu m·ªôt c√°ch hi·ªáu qu·∫£.

Trong b√†i vi·∫øt n√†y, ch√∫ng ta s·∫Ω kh√°m ph√° c√°ch s·ª≠ d·ª•ng WebSockets trong ng·ªØ c·∫£nh c·ªßa Spring WebFlux - m·ªôt ph·∫ßn c·ªßa Spring Framework d√†nh cho l·∫≠p tr√¨nh ph·∫£n h·ªìi nhanh v√† kh√¥ng ƒë·ªìng b·ªô. Ch√∫ng ta s·∫Ω ƒëi s√¢u v√†o c√°ch tri·ªÉn khai k·∫øt n·ªëi WebSocket, x·ª≠ l√Ω tin nh·∫Øn v√† qu·∫£n l√Ω tr·∫°ng th√°i k·∫øt n·ªëi. S·∫Ω th√∫ v·ªã khi ch√∫ng ta kh√°m ph√° c√°ch m√† Spring WebFlux gi√∫p ch√∫ng ta x√¢y d·ª±ng nh·ªØng ·ª©ng d·ª•ng ƒë·ªông, t∆∞∆°ng t√°c m√† ng∆∞·ªùi d√πng s·∫Ω y√™u th√≠ch.

## Ph√¢n bi·ªát Spring WebFlux v√† Spring Web

<Callout>V·∫≠y Spring Webflux kh√°c g√¨ so v·ªõi Spring Web?</Callout>

Spring Web v√† Spring Webflux ƒë·ªÅu l√† c√°c framework trong h·ªá sinh th√°i Spring ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ x√¢y d·ª±ng c√°c ·ª©ng d·ª•ng web, nh∆∞ng ch√∫ng c√≥ m·ªôt s·ªë kh√°c bi·ªát ch√≠nh.

- **Spring Web (Spring MVC)** ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ x·ª≠ l√Ω I/O ƒë·ªìng b·ªô, trong ƒë√≥ m·ªôt lu·ªìng b·ªã ch·∫∑n cho ƒë·∫øn khi nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ c∆° s·ªü d·ªØ li·ªáu ho·∫∑c d·ªãch v·ª• kh√°c.
- **Spring Webflux**, ng∆∞·ª£c l·∫°i, l√† m·ªôt framework web ph·∫£n ·ª©ng ƒë∆∞·ª£c x√¢y d·ª±ng tr√™n Reactive Streams. N√≥ ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ x·ª≠ l√Ω I/O kh√¥ng ƒë·ªìng b·ªô, trong ƒë√≥ m·ªôt lu·ªìng kh√¥ng b·ªã ch·∫∑n trong khi ƒëang ch·ªù ph·∫£n h·ªìi t·ª´ c∆° s·ªü d·ªØ li·ªáu ho·∫∑c d·ªãch v·ª• kh√°c.

<Figure
  imageUrl="https://res.cloudinary.com/dbscqlwl7/image/upload/v1695350150/blogs/Ung-dung-Websocket-vao-Spring-Webflux-tao-ung-dung-chat/Image_1_ejgr86.png"
  caption="Ph√¢n bi·ªát Spring WebFlux v√† Spring Web"
/>

## Kh√°i ni·ªám Spring Webflux

Spring Webflux r·∫•t ph√π h·ª£p cho c√°c ·ª©ng d·ª•ng y√™u c·∫ßu ƒë·ªô ƒë·ªìng th·ªùi cao, ch·∫≥ng h·∫°n nh∆∞ c√°c ·ª©ng d·ª•ng streaming ho·∫∑c x·ª≠ l√Ω d·ªØ li·ªáu th·ªùi gian th·ª±c.

Spring Webflux s·ª≠ d·ª•ng m·ªôt th∆∞ vi·ªán g·ªçi l√† reactor cho h·ªó tr·ª£ reactive v√† reactor l√† m·ªôt ƒë·ªëi t∆∞·ª£ng th·ª±c thi c·ªßa ƒë·∫∑c t·∫£¬†[Reactive Stream](https://github.com/reactive-streams/reactive-streams-jvm#reactive-streams). Reactor c√≥ 2 lo·∫°i ch√≠nh:

- **Flux**: ƒê∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ ƒë·∫°i di·ªán cho 0 ƒë·∫øn N ph·∫ßn t·ª≠.
- **Mono**: ƒê∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ ƒë·∫°i di·ªán cho 0 ƒë·∫øn 1 ph·∫ßn t·ª≠ ho·∫∑c m·ªôt ph·∫ßn t·ª≠ ƒë∆°n.

<Callout>Okay, h√£y b·∫Øt tay v√†o code th√¥i!!</Callout>

Trong ph·∫°m vi b√†i n√†y, ch√∫ng ta k·∫øt h·ª£p c√°c c√¥ng ngh·ªá sau: **Spring Webflux** + **Websocket** + **Thymeleaf**.

Maven dependencies:

```xml
<!-- Thymeleaf -->
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-thymeleaf</artifactId>
</dependency>

<!-- Webflux -->
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-webflux</artifactId>
</dependency>

<!-- Websocket -->
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-websocket</artifactId>
	<exclusions>
		<exclusion>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-tomcat</artifactId>
		</exclusion>
	</exclusions>
</dependency>
```

## C·∫•u h√¨nh WebSocket Configuration

ƒê·∫ßu ti√™n, ch√∫ng ta c·∫ßn t·∫°o m·ªôt l·ªõp th·ª´a k·∫ø t·ª´ WebSocketHandler v√† ghi ƒë√® c√°c ph∆∞∆°ng th·ª©c c·∫ßn thi·∫øt ƒë·ªÉ x·ª≠ l√Ω c√°c k·∫øt n·ªëi WebSocket t·ª´ ng∆∞·ªùi d√πng. Trong WebSocketHandler, ch√∫ng ta c√≥ th·ªÉ x·ª≠ l√Ω vi·ªác ƒëƒÉng k√Ω, hu·ª∑ ƒëƒÉng k√Ω v√† g·ª≠i tin nh·∫Øn.

## Qu·∫£n l√Ω k·∫øt n·ªëi

Trong WebSocketHandler, b·∫°n c·∫ßn m·ªôt c∆° ch·∫ø ƒë·ªÉ theo d√µi c√°c k·∫øt n·ªëi t·ª´ c√°c ng∆∞·ªùi d√πng. B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng m·ªôt Map ho·∫∑c c∆° ch·∫ø l∆∞u tr·ªØ kh√°c ƒë·ªÉ l∆∞u tr·ªØ danh s√°ch c√°c phi√™n k·∫øt n·ªëi c·ªßa ng∆∞·ªùi d√πng.

L∆∞u √Ω r·∫±ng ƒë√¢y ch·ªâ l√† m·ªôt v√≠ d·ª• c∆° b·∫£n ƒë·ªÉ c·∫•u h√¨nh WebSocketHandler trong Spring WebFlux. Trong th·ª±c t·∫ø, b·∫°n c·∫ßn x·ª≠ l√Ω c√°c s·ª± ki·ªán WebSocket nh∆∞ ƒëƒÉng k√Ω, g·ª≠i/nh·∫≠n tin nh·∫Øn, qu·∫£n l√Ω phi√™n, b·∫£o m·∫≠t, v.v. theo y√™u c·∫ßu c·ªßa ·ª©ng d·ª•ng c·ªßa b·∫°n.

```java
// ReactiveWebSocketHandler.java
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.socket.WebSocketHandler;
import org.springframework.web.reactive.socket.WebSocketMessage;
import org.springframework.web.reactive.socket.WebSocketSession;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import reactor.core.publisher.Sinks;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

@Component
public class ReactiveWebSocketHandler implements WebSocketHandler {

  private final Map < String, WebSocketSession > sessions = new ConcurrentHashMap < > ();

  @Override
  public Mono < Void > handle(WebSocketSession session) {
    sessions.put(session.getId(), session);

    Sinks.Many < String > userSink = Sinks.many().unicast().onBackpressureBuffer();
    Flux < String > receive = session.receive().map(WebSocketMessage::getPayloadAsText);
    return session.send(
        userSink.asFlux()
        .mergeWith(receive)
        .map(session::textMessage)
      )
      .doFinally(signalType -> {
        sessions.remove(session.getId());
      });
  }

  public void sendMessageToUser(String sessionId, String message) {
    WebSocketSession webSocketSession = sessions.get(sessionId);
    webSocketSession.send(Mono.just(webSocketSession.textMessage(message))).subscribe();
  }
}
```

## ƒêƒÉng k√Ω WebSocketHandler

Sau ƒë√≥, ch√∫ng ta c·∫•u h√¨nh WebSocketHandlerAdapter v√† ƒëƒÉng k√Ω WebSocketHandler v·ªõi ƒë∆∞·ªùng d·∫´n "/ws" b·∫±ng c√°ch s·ª≠ d·ª•ng SimpleUrlHandlerMapping.

```java
// WebSocketConfig.java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.config.EnableWebFlux;
import org.springframework.web.reactive.config.WebFluxConfigurer;
import org.springframework.web.reactive.handler.SimpleUrlHandlerMapping;
import org.springframework.web.reactive.socket.WebSocketHandler;
import org.springframework.web.reactive.socket.server.support.WebSocketHandlerAdapter;

import java.util.Map;

@Configuration
@EnableWebFlux
public class WebSocketConfig implements WebFluxConfigurer {

  @Bean
  public WebSocketHandlerAdapter handlerAdapter() {
    return new WebSocketHandlerAdapter();
  }

  @Bean
  public SimpleUrlHandlerMapping webSocketMapping(WebSocketHandler handler) {
    return new SimpleUrlHandlerMapping(Map.of("/ws", handler), -1); // ƒêƒÉng k√Ω ƒë∆∞·ªùng d·∫´n "/ws" v·ªõi WebSocketHandler
  }
}
```

## **C·∫•u h√¨nh Thymeleaf**

Khi s·ª≠ d·ª•ng Thymeleaf trong d·ª± √°n Spring WebFlux, c√°ch c·∫•u h√¨nh t∆∞∆°ng t·ª± nh∆∞ khi s·ª≠ d·ª•ng Spring MVC. Tuy nhi√™n, v√¨ Spring WebFlux ho·∫°t ƒë·ªông b·∫•t ƒë·ªìng b·ªô, b·∫°n c·∫ßn s·ª≠ d·ª•ng m·ªôt phi√™n b·∫£n Thymeleaf th√≠ch h·ª£p cho h·ªá th·ªëng b·∫•t ƒë·ªìng b·ªô.

```java
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.CacheControl;
import org.springframework.web.reactive.config.ResourceHandlerRegistry;
import org.springframework.web.reactive.config.ViewResolverRegistry;
import org.springframework.web.reactive.config.WebFluxConfigurer;
import org.springframework.web.reactive.resource.VersionResourceResolver;
import org.thymeleaf.spring6.ISpringWebFluxTemplateEngine;
import org.thymeleaf.spring6.SpringWebFluxTemplateEngine;
import org.thymeleaf.spring6.templateresolver.SpringResourceTemplateResolver;
import org.thymeleaf.spring6.view.reactive.ThymeleafReactiveViewResolver;
import org.thymeleaf.templatemode.TemplateMode;

import java.util.concurrent.TimeUnit;

@Configuration
public class WebConfig implements ApplicationContextAware, WebFluxConfigurer {

  private ApplicationContext ctx;

  @Override
  public void setApplicationContext(ApplicationContext context) {
    this.ctx = context;
  }

  @Bean
  public SpringResourceTemplateResolver thymeleafTemplateResolver() {

    final SpringResourceTemplateResolver resolver = new SpringResourceTemplateResolver();
    resolver.setApplicationContext(this.ctx);
    resolver.setPrefix("classpath:/templates/");
    resolver.setSuffix(".html");
    resolver.setTemplateMode(TemplateMode.HTML);
    resolver.setCacheable(false);
    resolver.setCheckExistence(false);
    return resolver;

  }

  @Override
  public void addResourceHandlers(ResourceHandlerRegistry registry) {
    registry.addResourceHandler("/**")
      .addResourceLocations("/public", "classpath:/static/")
      .setCacheControl(CacheControl.maxAge(365, TimeUnit.DAYS))
      .resourceChain(true)
      .addResolver(new VersionResourceResolver().addContentVersionStrategy("/**"));
  }

  @Bean
  public ISpringWebFluxTemplateEngine thymeleafTemplateEngine() {
    final SpringWebFluxTemplateEngine templateEngine = new SpringWebFluxTemplateEngine();
    templateEngine.setTemplateResolver(thymeleafTemplateResolver());
    return templateEngine;
  }

  @Bean
  public ThymeleafReactiveViewResolver thymeleafChunkedAndDataDrivenViewResolver() {
    final ThymeleafReactiveViewResolver viewResolver = new ThymeleafReactiveViewResolver();
    viewResolver.setTemplateEngine(thymeleafTemplateEngine());
    viewResolver.setResponseMaxChunkSizeBytes(8192);
    return viewResolver;
  }

  @Override
  public void configureViewResolvers(ViewResolverRegistry registry) {
    registry.viewResolver(thymeleafChunkedAndDataDrivenViewResolver());
  }
}
```

Sau khi ƒë√£ c·∫•u h√¨nh xong t·∫•t c·∫£ c√°c th√†nh ph·∫ßn c·ªßa WebSocket tr√™n Spring WebFlux, b∆∞·ªõc cu·ªëi c√πng l√† ki·ªÉm tra th√†nh ph·∫©m.

## Ki·ªÉm tra (testing)

<Callout>C√≤n ch·∫ßn ch·ªù g√¨ n·ªØa, start ·ª©ng d·ª•ng test th√¥i!!</Callout>

- **B∆∞·ªõc 1**: Truy c·∫≠p v√†o http://localhost:8080/

<img
  width="500"
  height="500"
  src="https://res.cloudinary.com/dbscqlwl7/image/upload/v1695362942/blogs/Ung-dung-Websocket-vao-Spring-Webflux-tao-ung-dung-chat/Image_2_f0hmtt.png"
/>

- **B∆∞·ªõc 2**: Nh·∫≠p tin nh·∫Øn v√† g·ª≠i

<img
  width="500"
  height="500"
  src="https://res.cloudinary.com/dbscqlwl7/image/upload/v1695362942/blogs/Ung-dung-Websocket-vao-Spring-Webflux-tao-ung-dung-chat/Image_3_wmbi5z.png"
/>

- **B∆∞·ªõc 3**: M·ªü m·ªôt tab m·ªõi ƒë·ªÉ test g·ª≠i tin nh·∫Øn ƒë·∫øn t·∫•t c·∫£ trong chanel

<img
  width="500"
  height="500"
  src="https://res.cloudinary.com/dbscqlwl7/image/upload/v1695362942/blogs/Ung-dung-Websocket-vao-Spring-Webflux-tao-ung-dung-chat/Image_4_ihs5zp.png"
/>

- **B∆∞·ªõc 4**: Quay l·∫°i tab c≈© ƒë·ªÉ ki·ªÉm tra tin nh·∫Øn g·ª≠i ƒë·∫øn m·ªçi ng∆∞·ªùi trong channel

<img
  width="500"
  height="500"
  src="https://res.cloudinary.com/dbscqlwl7/image/upload/v1695362944/blogs/Ung-dung-Websocket-vao-Spring-Webflux-tao-ung-dung-chat/Image_5_jcb1ve.png"
/>

<Callout>
  T√≥m l·∫°i, n·∫øu b·∫°n ƒëang x√¢y d·ª±ng m·ªôt ·ª©ng d·ª•ng web truy·ªÅn th·ªëng v·ªõi giao ti·∫øp
  ƒë·ªìng b·ªô, th√¨ Spring Web c√≥ th·ªÉ l√† l·ª±a ch·ªçn t·ªët cho b·∫°n. N·∫øu b·∫°n ƒëang x√¢y d·ª±ng
  m·ªôt ·ª©ng d·ª•ng c√≥ t√≠nh ƒë·ªìng th·ªùi cao v·ªõi I/O kh√¥ng ch·∫∑n, th√¨ Spring Webflux c√≥
  th·ªÉ l√† l·ª±a ch·ªçn t·ªët h∆°n.
</Callout>

üëâ Full source code: [Github Repo](https://github.com/minhjavapc/blogs/tree/master/Spring-Webflux-Websocket-Thymleeaf)
